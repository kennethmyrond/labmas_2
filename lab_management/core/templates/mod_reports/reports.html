{% extends 'temp_navbar.html' %}
{% block title %}Reports{% endblock %}
{% block content %}

<div class="container">
    <!-- Filter Section -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Filter by Date Range and Item</h5>
            <form id="filterForm" method="GET" action="{% url 'reports' %}">
                <div class="row">
                    <div class="col-md-3">
                        <label for="item_id" class="form-label">Select Item:</label>
                        <select class="form-select" id="item_id" name="item_id">
                            {% for item in all_items %}
                                <option value="{{ item.item_id }}" {% if item_id == item.item_id %}selected{% endif %}>{{ item.item_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="dateType" class="form-label">Select Date Type:</label>
                        <select class="form-select" id="dateType" name="dateType">
                            <option value="today" {% if date_type == 'today' %}selected{% endif %}>Today</option>
                            <option value="day" {% if date_type == 'day' %}selected{% endif %}>Specific Day</option>
                            <option value="week" {% if date_type == 'week' %}selected{% endif %}>Specific Week</option>
                            <option value="month" {% if date_type == 'month' %}selected{% endif %}>Specific Month</option>
                            <option value="year" {% if date_type == 'year' %}selected{% endif %}>Specific Year</option>
                            <option value="timeframe" {% if date_type == 'timeframe' %}selected{% endif %}>Timeframe</option>
                        </select>
                    </div>

                    <div class="col-md-3" id="dateInput" style="display: none;">
                        <label for="date" class="form-label">Select Date:</label>
                        <input type="date" class="form-control" id="date" name="date" value="{{date}}">
                    </div>

                    <div class="col-md-3" id="timeframeInputs1" style="display: none;">
                        <label for="startDate" class="form-label">From:</label>
                        <input type="date" class="form-control" id="startDate" name="startDate" value="{{start_date}}">
                    </div>

                    <div class="col-md-3" id="timeframeInputs2" style="display: none;">
                        <label for="endDate" class="form-label mt-2">To:</label>
                        <input type="date" class="form-control" id="endDate" name="endDate" value="{{end_date}}">
                    </div>

                    <div class="col-md-3 align-self-end">
                        <button type="submit" class="btn btn-primary">Generate Report</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Inventory Stock Report Table -->
    <div class="card col">
        <div class="card-body">
            <h5 class="card-title">Stock Level Based on the Selected Date</h5>
            <canvas id="inventoryStockChart"></canvas>
            <hr>
            
            <table id="inventoryTable" class="table datatable table-striped ">
                <thead>
                    <tr>
                        <th>Item ID</th>
                        <th>Item Name</th>
                        <th>Item Type</th>
                        <th>Current Stock Level</th>
                        <th hidden></th>
                        <th hidden></th>
                        <th hidden></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in inventory_data %}
                    <tr>
                        <td>{{ item.item_id }}</td>
                        <td>{{ item.item_name }}</td>
                        <td>{{ item.item_type__itemType_name }}</td>
                        <td>{{ item.current_qty }}</td>
                        <td hidden></td>
                        <td hidden></td>
                        <td hidden></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Item Trend Graph Section -->
    <div class="container mt-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Item Inventory and Borrowing Trends</h5>
                <canvas id="itemTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Borrowing Trends Report -->
    <h3>Borrowing Trends</h3>
    <canvas id="borrowingTrendsChart"></canvas>

    <!-- Room Usage Report -->
    <h3>Room Usage</h3>
    <canvas id="roomUsageChart"></canvas>

    <!-- Maintenance & Repairs Report -->
    <h3>Reported Damaged Items</h3>
    <canvas id="maintenanceRepairsChart"></canvas>
</div>


<script>
    $(document).ready(function () {
        let today = new Date()
        // Handle showing/hiding of input fields based on date type
        $('#dateType').change(function () {
            var dateType = $(this).val();
            if (dateType === 'timeframe') {
                $('#timeframeInputs1').show();
                $('#timeframeInputs2').show();
                $('#dateInput').hide();
            } else if (dateType !== 'today') {
                $('#dateInput').show();
                $('#timeframeInputs1').hide();
                $('#timeframeInputs2').hide();
                if(dateType === 'week'){
                    document.getElementById("date").attributes["type"].value = "week";
                } else if(dateType === 'month'){
                    document.getElementById("date").attributes["type"].value = "month";
                } else if (dateType === 'year'){
                    var date = document.getElementById("date");
                    date.attributes["type"].value = "number";
                    date.min = "1900";
                    date.max = "2999";
                    date.value = "2024"
                } else{
                    // get date today as max input
                    var dtToday = new Date();
                    var month = dtToday.getMonth() + 1;
                    var day = dtToday.getDate();
                    var year = dtToday.getFullYear();
                    if(month < 10)
                        month = '0' + month.toString();
                    if(day < 10)
                        day = '0' + day.toString();
                    var maxDate = year + '-' + month + '-' + day;    
                    $('#date').attr('max', maxDate);

                    document.getElementById("date").attributes["type"].value = "date";
                }
            } else {
                $('#dateInput').hide();
                $('#timeframeInputs1').hide();
                $('#timeframeInputs2').hide();
            }
        });

        $('#startDate').change(function () {
            var startDate = $(this).val();
            $('#endDate').attr('min', startDate);
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Inventory Stock Report Chart
    const inventoryData = {
        labels: [{% for item in combined_data %}'{{ item.item_name }}',{% endfor %}],
        datasets: [
            {
                label: 'Stock Quantity',
                data: [{% for item in combined_data %}{{ item.current_qty }},{% endfor %}],
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            },
            {
                label: 'Total Borrowed Quantity',
                data: [{% for item in combined_data %}{{ item.total_borrowed }},{% endfor %}],
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
            }
        ]
    };
    const inventoryConfig = {
        type: 'bar',
        data: inventoryData,
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    };
    const inventoryStockChart = new Chart(document.getElementById('inventoryStockChart'), inventoryConfig);

    // Item Trend Chart
    const itemTrendData = {
        labels: [{% for data in inventory_data %}'{{ data.date|date:"Y-m-d" }}',{% endfor %}],
        datasets: [
            {
                label: 'Inventory Quantity',
                data: [{% for data in inventory_data %}{{ data.total_qty }},{% endfor %}],
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                fill: true
            },
            {
                label: 'Borrowed Quantity',
                data: [{% for data in borrowing_data %}{{ data.total_borrowed }},{% endfor %}],
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1,
                fill: true
            }
        ]
    };
    const itemTrendConfig = {
        type: 'line',
        data: itemTrendData,
        options: { responsive: true, scales: { y: { beginAtZero: true }, x: { type: 'time', time: { unit: "{{ date_type }}" } } } }
    };
    const itemTrendChart = new Chart(document.getElementById('itemTrendChart'), itemTrendConfig);

    // Borrowing Trends Report Chart
    const borrowingData = {
        labels: [{% for borrow in borrowing_data %}'{{ borrow.item__item_name }}',{% endfor %}],
        datasets: [{ label: 'Total Borrowed Quantity', data: [{% for borrow in borrowing_data %}{{ borrow.total_borrowed }},{% endfor %}], backgroundColor: 'rgba(255, 159, 64, 0.2)', borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 1 }]
    };
    const borrowingConfig = {
        type: 'bar',
        data: borrowingData,
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    };
    const borrowingTrendsChart = new Chart(document.getElementById('borrowingTrendsChart'), borrowingConfig);

    // Room Usage Report Chart
    const roomUsageData = {
        labels: [{% for room in room_usage_data %}'{{ room.room__name }}',{% endfor %}],
        datasets: [{ label: 'Total Reservations', data: [{% for room in room_usage_data %}{{ room.total_reservations }},{% endfor %}], backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }]
    };
    const roomUsageConfig = {
        type: 'bar',
        data: roomUsageData,
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    };
    const roomUsageChart = new Chart(document.getElementById('roomUsageChart'), roomUsageConfig);

    // Maintenance & Repairs Report Chart
    const maintenanceData = {
        labels: [{% for report in maintenance_data %}'{{ report.item__item_name }}',{% endfor %}],
        datasets: [{ label: 'Total Damaged Items Reported', data: [{% for report in maintenance_data %}{{ report.total_reported }},{% endfor %}], backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 }]
    };
    const maintenanceConfig = {
        type: 'bar',
        data: maintenanceData,
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    };
    const maintenanceRepairsChart = new Chart(document.getElementById('maintenanceRepairsChart'), maintenanceConfig);
</script>
{% endblock %}
