<!-- Add Select2 CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

{% extends 'temp_navbar.html' %}
{% load socialaccount %}
{% block title %}Update Item in Inventory{% endblock %}

{% block content %}
<div class="pagetitle">
    <h1>Inventory</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'inventory_view' %}">Inventory</a></li>
            <li class="breadcrumb-item active">Update Item Quantity</li>
        </ol>
    </nav>
</div>

<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Update Item Quantity</h5>

                    <form id="updateForm" onsubmit="event.preventDefault(); addItem();">
                        {% csrf_token %}
                        
                        <!-- Action Type Dropdown -->
                        <div class="row mb-3">
                            <label for="actionType" class="col-sm-2 col-form-label">Action:</label>
                            <div class="col-sm-10">
                                <select class="form-select" id="actionType" name="action_type" required onchange="toggleActionFields()">
                                    <option value="add">Add to Inventory</option>
                                    <option value="remove">Remove from Inventory</option>
                                </select>
                            </div>
                        </div>

                        <!-- Item Name Dropdown -->
                        <div class="row mb-3">
                            <label for="itemName" class="col-sm-2 col-form-label">Item Name:</label>
                            <div class="col-sm-10">
                                <select class="form-control" id="itemName" name="item_name" style="width: 100%;" required>
                                    <!-- Options will be dynamically loaded via AJAX -->
                                </select>
                                <div id="itemNameError" class="text-danger mt-2" style="display:none;">
                                    Invalid item. <a href="{% url 'inventory_addNewItem' %}">Add a new item.</a>
                                </div>
                            </div>
                        </div>

                        <!-- Supplier Dropdown -->
                        <div class="row mb-3">
                            <label for="itemSupplier" class="col-sm-2 col-form-label">Supplier:</label>
                            <div class="col-sm-10">
                                <select class="form-control" id="itemSupplier" name="item_supplier" style="width: 100%;" required>
                                    <!-- Options will be dynamically loaded via AJAX -->
                                </select>
                            </div>
                        </div>

                        <!-- Quantity, Date, Price Fields -->
                        <div id="addFields">
                            <div class="row mb-3">
                                <label for="amount" class="col-sm-2 col-form-label">Quantity Bought:</label>
                                <div class="col-sm-10">
                                    <input type="number" class="form-control" name="amount" id="amount" required>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label for="inputDatePurchased" class="col-sm-2 col-form-label">Date Purchased:</label>
                                <div class="col-sm-10">
                                    <input type="datetime-local" class="form-control" name="item_date_purchased" id="item_date_purchased">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <label for="inputDateReceived" class="col-sm-2 col-form-label">Date Received:</label>
                                <div class="col-sm-10">
                                    <input type="datetime-local" class="form-control" name="item_date_received" id="item_date_received">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label for="inputText" class="col-sm-2 col-form-label">Unit Price:</label>
                                <div class="col-sm-10">
                                    <input type="number" class="form-control" name="item_price" id="item_price" step="0.01">
                                </div>
                            </div>
                        </div>

                        <!-- Add and Clear Buttons -->
                        <div class="row mb-3">
                            <div class="col-sm-10 d-flex">
                                <button type="submit" class="btn btn-primary me-2" id="add">Add</button>
                                <button type="reset" class="btn btn-secondary" id="clear">Clear</button>
                            </div>
                        </div>
                    </form>

                    <!-- Items Table -->
                    <section class="section">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Items</h5>
                                        <table class="table datatable" id="itemsTable">
                                            <thead>
                                                <tr>
                                                    <th>Item Name</th>
                                                    <th>Qty</th>
                                                    <th>Price</th>
                                                    <th>Supplier</th>
                                                    <th>Date Purchased</th>
                                                    <th>Date Received</th>
                                                </tr>
                                            </thead>
                                            <tbody id="itemList">
                                                <!-- Items will be dynamically added here -->
                                            </tbody>
                                        </table>
                                        <button type="button" class="btn btn-success" onclick="saveTransaction()">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Initialize Select2 for item and supplier fields
    $(document).ready(function() {
        $('#itemName').select2({
            ajax: {
                url: '/suggest_items/',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        query: params.term // Search term
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.map(function(item) {
                            return {
                                id: item.item_id,
                                text: `${item.item_name} - ${item.amount}${item.dimension}`  // Format item name and amount/dimension
                            };
                        })
                    };
                },
                placeholder: 'Search for an item',
                minimumInputLength: 2
            }
        });

        $('#itemSupplier').select2({
            ajax: {
                url: '/suggest_suppliers/',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        query: params.term // Search term
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.map(function(supplier) {
                            return {
                                id: supplier.suppliers_id,
                                text: supplier.supplier_name
                            };
                        })
                    };
                },
                placeholder: 'Search for a supplier',
                minimumInputLength: 2
            }
        });
    });

    // Function to dynamically add items to the table
    function addItem() {
        const itemNameDropdown = $('#itemName').select2('data')[0];
        const supplierDropdown = $('#itemSupplier').select2('data')[0];
        const amount = document.getElementById('amount').value;
        const itemDatePurchased = document.getElementById('item_date_purchased').value;
        const itemDateReceived = document.getElementById('item_date_received').value;
        const itemPrice = document.getElementById('item_price').value;

        if (!itemNameDropdown || !supplierDropdown) {
            document.getElementById('itemNameError').style.display = 'block';
            return;
        }

        const table = document.getElementById('itemList');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>${itemNameDropdown.text} (ID: ${itemNameDropdown.id})</td>
            <td>${amount}</td>
            <td>${itemPrice}</td>
            <td>${supplierDropdown.text} (ID: ${supplierDropdown.id})</td>
            <td>${itemDatePurchased || '-'}</td>
            <td>${itemDateReceived || '-'}</td>
        `;
        table.appendChild(newRow);

        document.getElementById('updateForm').reset();
    }

    // Function to save the transaction
    function saveTransaction() {
        const tableRows = document.querySelectorAll('#itemList tr');
        const items = Array.from(tableRows).map(row => {
            const columns = row.querySelectorAll('td');
            return {
                item_id: columns[0].textContent.split('(ID: ')[1].slice(0, -1), // Extract item_id
                qty: columns[1].textContent,
                item_price: columns[2].textContent,
                supplier_id: columns[3].textContent.split('(ID: ')[1].slice(0, -1), // Extract supplier_id
                date_purchased: columns[4].textContent,
                date_received: columns[5].textContent
            };
        });

        fetch('{% url "inventory_updateItem" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ items })
        })
        .then(response => response.json())
        .then(data => {
            alert('Transaction saved successfully!');
            location.reload();
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
