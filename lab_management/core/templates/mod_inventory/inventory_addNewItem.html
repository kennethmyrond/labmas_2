{% extends 'temp_navbar.html' %}
{% load socialaccount %}
{% load qr_code %}
{% load custom_filters %}

{% block title %}Add New Item in Inventory{% endblock %}

{% block content %}
<div class="pagetitle">
    <h1>Inventory</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item active">Add New Item</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Add New Item</h5>
                    
                    <!-- General Form Elements -->
                    <form method="POST">
                        {% csrf_token %}

                        <div class="row mb-3">
                            <label for="inputText" class="col-sm-2 col-form-label">Item Type:</label>
                            <div class="col-sm-10">
                                <select class="form-select" id="item_type" name="item_type" onchange="handleItemTypeChange()" required>
                                    {% for type in item_types %}
                                        <option value="{{ type.itemType_id }}" data-add-cols="{{ type.add_cols }}">{{ type.itemType_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <label for="inputText" class="col-sm-2 col-form-label">Item Name:</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="item_name" name="item_name" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <label for="inputNumber" class="col-sm-2 col-form-label">Unit:</label>
                            <div class="col-sm-10">
                                <input type="number" class="form-control" id="unit" name="unit">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="inputText" class="col-sm-2 col-form-label">Dimension:</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="item_dimension" name="item_dimension">
                            </div>
                        </div>

                        <!-- Additional columns -->
                        <div id="additional_fields_container"></div>

                        <div class="row mb-3">
                          <label for="inputText" class="col-sm-2 col-form-label">Record Expiration Date?</label>
                          <div class="col-sm-10">
                              <input type="checkbox" id="rec_expiration" name="rec_expiration">
                        </div>
                        <div class="row mb-3">
                          <label for="inputText" class="col-sm-2 col-form-label">Alert Minimum Quantity?</label>
                          <div class="col-sm-10">
                              <input type="checkbox" id="min_qty" name="min_qty" onchange="toggleAlertQty()">
                          </div>
                        </div>
                        <div class="row mb-3" id="alert_qty_container" style="display: none;">
                            <label for="inputNumber" class="col-sm-2 col-form-label">Minimum Quantity Level:</label>
                            <div class="col-sm-10">
                                <input type="number" class="form-control" id="alert_qty" name="alert_qty" value="0">
                            </div>
                        </div>
                      </div>

                        <div class="row mb-5 ">
                            <div class="col-sm-10 d-flex align-items-center">
                                <button type="submit" class="btn btn-primary me-3" id="submit">Add New Item</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Success Modal -->
{% if show_modal %}
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">Item Added Successfully</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Item "<strong>{{ new_item.item_name }} - {{ new_item.amount }}{{ new_item.dimension }}</strong>" has been successfully added to the inventory.</p>
                <p>Download the QR code below for quick inventory:</p>
                <div class="text-center">
                    {% if qr_code_data %}
                        <img id="qrCodeImage" src="data:image/png;base64,{{ qr_code_data}}" alt="QR Code" class="img-fluid">
                    {% else %}
                        <p>No QR code available.</p>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
              <!-- Download Button -->
              <a id="downloadQrCode" class="btn btn-success" download="qr_code.png">Download QR Code</a>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
    </div>
</div>

<!-- Trigger modal on page load -->
<script>
    $(document).ready(function() {
        $('#successModal').modal('show');
    });

    document.addEventListener('DOMContentLoaded', function() {
        // This function will be triggered when the modal is shown
        $('#successModal').on('shown.bs.modal', function () {
            // Get the base64 image data from the img tag
            const qrCodeImage = document.getElementById('qrCodeImage').src;

            // Set the download attribute of the download link
            const downloadLink = document.getElementById('downloadQrCode');
            downloadLink.href = qrCodeImage;
        });
    });
</script>
{% endif %}

<script>
    function handleItemTypeChange() {
    const selectElement = document.getElementById('item_type');
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const addColsJson = selectedOption.getAttribute('data-add-cols');
    
    // Parse the add_cols JSON string
    let addCols = [];
    if (addColsJson) {
        try {
            addCols = JSON.parse(addColsJson);
        } catch (e) {
            console.error('Invalid JSON format in add_cols:', e);
        }
    }

    // Clear the additional fields container
    const additionalFieldsContainer = document.getElementById('additional_fields_container');
    additionalFieldsContainer.innerHTML = '';

    // Dynamically generate new fields if add_cols is present
    if (addCols.length > 0) {
        addCols.forEach((col) => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row mb-3';

            // Extract field name and potential dropdown options
            const regex = /(.*)\s\((.*)\)/;
            const match = col.match(regex);

            let fieldName = col;
            let isDropdown = false;
            let options = [];

            if (match) {
                fieldName = match[1]; // Use only the name before the parentheses (e.g., "Status")
                isDropdown = true;
                options = match[2].split(',').map(option => option.trim()); // Split the options (e.g., "Status 1, Status 2, Status 3")
            }

            const labelDiv = document.createElement('label');
            labelDiv.className = 'col-sm-2 col-form-label';
            labelDiv.textContent = fieldName + ':'; // Only display the field name (e.g., "Status")
            rowDiv.appendChild(labelDiv);

            const inputDiv = document.createElement('div');
            inputDiv.className = 'col-sm-10';

            if (isDropdown) {
                // Create a dropdown (select) element if the field has fixed options
                const selectElement = document.createElement('select');
                selectElement.className = 'form-select';
                selectElement.name = `add_col_${fieldName.toLowerCase()}`;

                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    selectElement.appendChild(optionElement);
                });

                inputDiv.appendChild(selectElement);
            } else {
                // Create a text input for fields without fixed options
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.className = 'form-control';
                inputElement.name = `add_col_${col.toLowerCase()}`;
                inputDiv.appendChild(inputElement);
            }

            rowDiv.appendChild(inputDiv);
            additionalFieldsContainer.appendChild(rowDiv);
        });
    }
}

// Initialize the form based on the default selection
document.addEventListener('DOMContentLoaded', handleItemTypeChange);


    // Initialize the form based on the default selection
    document.addEventListener('DOMContentLoaded', handleItemTypeChange);

  function toggleAlertQty() {
    var minQtyCheckbox = document.getElementById('min_qty');
    var alertQtyContainer = document.getElementById('alert_qty_container');
    var alertQtyInput = document.getElementById('alert_qty');

    if (minQtyCheckbox.checked) {
        alertQtyContainer.style.display = 'block';
    } else {
        alertQtyContainer.style.display = 'none';
        alertQtyInput.value = 0;
    }
  }
</script>

{% endblock %}
