{% extends 'temp_navbar.html' %}
{% block title %}Pre-Book Requests{% endblock %}

{% block content %}
  <style>
    .btncontainer {
      text-align: right;
    }
  </style>

  <div class="pagetitle">
    <h1>Borrowing</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item active">Borrowing Configurations</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->

  {% if messages %}
  <div class="alert alert-success">
    {% for message in messages %}
      {{ message }}
    {% endfor %}
  </div>
  {% endif %}

  <section class="section">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Configurations</h5>

            <!-- Form for General Laboratory Configurations -->
            <form method="POST" id="labConfigForm">
              {% csrf_token %}
              <input type="none" name="lab_config_form" value="1" hidden> <!-- none input to differentiate forms -->

              <div class="row mb-3">
                <label for="walkin" class="col-sm-2 col-form-label">Allow Walk-Ins:</label>
                <div class="col-sm-10">
                  <input type="checkbox" id="walkin" name="allow_walkin" value="on" {% if lab.allow_walkin %}checked{% endif %}>
                </div>
              </div>

              <div class="row mb-3">
                <label for="prebook" class="col-sm-2 col-form-label">Allow Pre-Booking:</label>
                <div class="col-sm-10">
                  <input type="checkbox" id="prebook" name="allow_prebook" value="on" {% if lab.allow_prebook %}checked{% endif %}>
                </div>
              </div>
              {% if lab.allow_prebook %}
              <div class="row mb-3">
                <label class="col-sm-2 col-form-label">Pre-Booking Lead Time:</label>
                <div class="col-sm-10">
                  <input type="number" name="prebook_lead_time" value="{{ lab.prebook_lead_time|default_if_none:'' }}">
                  <small>Set a lead time for pre-booking (e.g., 24 hours)</small>
                </div>
              </div>
              {% endif %}
              <div class="row mb-3">
                <label for="shortterm" class="col-sm-2 col-form-label">Allow Short-Term Booking:</label>
                <div class="col-sm-10">
                  <input type="checkbox" id="shortterm" name="allow_shortterm" value="on" {% if lab.allow_shortterm %}checked{% endif %}>
                </div>
              </div>

              <div class="row mb-3">
                <label for="longterm" class="col-sm-2 col-form-label">Allow Long-Term Booking:</label>
                <div class="col-sm-10">
                  <input type="checkbox" id="longterm" name="allow_longterm" value="on" {% if lab.allow_longterm %}checked{% endif %}>
                </div>
              </div>

              <div class="btncontainer">
                <button class="btn btn-primary" id="savebtn-lab-config">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Form for Borrowing Configuration by Item or Item Type -->
  <section class="section item-config-section">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Borrowing Mode</h5>

            <form method="POST" id="borrowConfigForm">
              {% csrf_token %}
              <input type="none" name="borrow_config_form" value="1" hidden> <!-- none input to differentiate forms -->

              <div class="form-group">
                <label>Select Borrowing Configuration Mode:</label><br>
                <input type="radio" id="itemMode" name="borrowMode" value="item" checked>
                <label for="itemMode">By Specific Item</label><br>
                <input type="radio" id="typeMode" name="borrowMode" value="type">
                <label for="typeMode">By Item Type</label><br>
              </div>

              <!-- Section to configure by specific items -->
              <section id="itemConfigSection">
                <h5 class="card-title">Borrowable Items Configurations</h5>
                <table class="table datatable">
                  <thead>
                    <tr>
                      <th>Item Name</th>
                      <th>Item Type</th>
                      <th>Allow Borrowing?</th>
                      <th style="display:none"></th>
                      <th style="display:none"></th>
                      <th style="display:none"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in items %}
                    <tr>
                      <td>{{ item.item_name }}</td>
                      <td>{{ item.itemType.itemType_name }}</td> <!-- Item Type column -->
                      <td>
                        <input type="checkbox" name="borrow_item" value="{{ item.item_id }}" 
                               {% if item.allow_borrow %}checked{% endif %}>
                      </td>
                      <td style="display:none"></td>
                      <td style="display:none"></td>
                      <td style="display:none"></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </section>

              <!-- Section to configure by item types -->
              <section id="itemTypeConfigSection" style="display:none;">
                <h5 class="card-title">Borrowable Item Types Configurations</h5>
                <table class="table datatable">
                  <thead>
                    <tr>
                      <th>Item Type</th>
                      <th>Allow Borrowing?</th>
                      <th>Make Consumable?</th>
                      <th style="display:none"></th>
                      <th style="display:none"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for type in item_types_list %}
                    <tr>
                      <td>{{ type.itemType_name }}</td>
                      <td>
                        <input type="checkbox" class="borrow-type-checkbox" name="borrow_item_type" value="{{ type.itemType_id }}" 
                               {% if type.all_items_borrowable %}checked{% endif %}>
                      </td>
                      <td>
                        <input type="checkbox" name="is_consumable_{{ type.itemType_id }}" 
                               {% if type.is_consumable %}checked{% endif %}>
                      </td>
                      <td style="display:none"></td>
                      <td style="display:none"></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </section>

              <div class="btncontainer">
                <button class="btn btn-primary" id="savebtn-borrow-config">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Function to toggle between item and item type config
    document.querySelectorAll('input[name="borrowMode"]').forEach(function(input) {
      input.addEventListener('change', function() {
        if (this.value === 'item') {
          document.getElementById('itemConfigSection').style.display = 'block';
          document.getElementById('itemTypeConfigSection').style.display = 'none';
        } else {
          document.getElementById('itemConfigSection').style.display = 'none';
          document.getElementById('itemTypeConfigSection').style.display = 'block';
        }
      });
    });

    // Handle type borrowability check/uncheck and update all items accordingly
    document.querySelectorAll('.borrow-type-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          const typeId = this.value;
          const checkboxes = document.querySelectorAll('input[name="borrow_item"][data-item-type="' + typeId + '"]');
          checkboxes.forEach(function(itemCheckbox) {
            itemCheckbox.checked = checkbox.checked; // Set the item's borrowable status to match the type's
          });
        });
      });
  </script>

{% endblock %}
