{% extends 'temp_navbar.html' %}
{% load socialaccount %}
{% block title %}View Pre-Book Requests{% endblock %}

{% block content %}
  <div class="pagetitle">
    <h1>Borrowing</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item active">View My Borrowed Items</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->

  {% if lab_config.allow_prebook %}
  
  <!-- Tabs for different statuses -->
  <ul class="nav nav-tabs" id="borrowRequestsTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="pending-tab" data-toggle="tab" href="#pre-pending" role="tab">Pending</a>
  </li>
    <li class="nav-item">
      <a class="nav-link" id="accepted-tab" data-toggle="tab" href="#accepted" role="tab">Accepted</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="declined-tab" data-toggle="tab" href="#declined" role="tab">Declined</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="borrowed-tab" data-toggle="tab" href="#borrowed" role="tab">Borrowed</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="cancelled-tab" data-toggle="tab" href="#cancelled" role="tab">Cancelled</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="completed-tab" data-toggle="tab" href="#completed" role="tab">Completed</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="all-tab" data-toggle="tab" href="#all" role="tab">All</a>
    </li>
  </ul>

  <!-- Tab content -->
  <div class="tab-content" id="borrowRequestsContent">
    
    <!-- Pending Requests Tab -->
    <!-- Pending Pre-Book Requests Tab -->
    <div class="tab-pane fade show active" id="pre-pending" role="tabpanel">
      <section class="section">
          <div class="card">
              <div class="card-body">
                  <table class="table datatable">
                      <thead>
                          <tr>
                              <th>Borrow ID</th>
                              <th>Date Requested</th>
                              <th>Date Needed</th>
                              <th>Due Date</th>
                              <th>Type</th>
                              <th>Action</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for request in pending_requests %}
                          <tr>
                            <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                              <td>{{ request.request_date|date:"Y/m/d" }}</td>
                              <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                              <td>{{ request.due_date|date:"Y/m/d" }}</td>
                              <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                              <td><button class="btn btn-danger btn-sm" onclick="cancelRequest('{{ request.borrow_id }}', 'prebook')">Cancel</button></td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
          </div>
      </section>
    </div>
    <!-- Accepted Requests Tab -->
    <div class="tab-pane fade" id="accepted" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
                  <th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in accepted_requests %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
    <!-- Declined Requests Tab -->
    <div class="tab-pane fade" id="declined" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
                  <th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in declined_requests %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                   
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
    <!-- Borrowed Requests Tab -->
    <div class="tab-pane fade" id="borrowed" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
                  <th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in borrowed_requests %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                   
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
    <!-- Cancelled Requests Tab -->
    <div class="tab-pane fade" id="cancelled" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
                  <th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in cancelled_requests %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                   
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
    <!-- Completed Requests Tab -->
    <div class="tab-pane fade" id="completed" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
                  <th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in completed_requests %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                   
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
    <!-- All Requests Tab -->
    <div class="tab-pane fade" id="all" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
<th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in prebook_requests_all %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                   
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>
  {% endif %}

  {% if lab_config.allow_walkin %}
  <!-- Walk-In Requests Section -->
  <h3>Walk-In Requests</h3>
  <!-- Tabs for different statuses -->
  <ul class="nav nav-tabs" id="walkInRequestsTabs" role="tablist">
      <li class="nav-item">
          <a class="nav-link active" id="walkin-accepted-tab" data-toggle="tab" href="#walkin-accepted" role="tab">Requested</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" id="walkin-borrowed-tab" data-toggle="tab" href="#walkin-borrowed" role="tab">Borrowed</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" id="walkin-cancelled-tab" data-toggle="tab" href="#walkin-cancelled" role="tab">Cancelled</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" id="walkin-completed-tab" data-toggle="tab" href="#walkin-completed" role="tab">Completed</a>
      </li>
  </ul>

  <!-- Walk-In Tab content -->
  <div class="tab-content" id="walkInRequestsContent">
          <!-- Accepted Requests Tab -->
    <div class="tab-pane fade show active" id="walkin-accepted" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
<th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in walkin_accepted_requests %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                   
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <!-- Borrowed Requests Tab -->
    <div class="tab-pane fade" id="walkin-borrowed" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
<th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in walkin_borrowed_requests %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                   
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <!-- Cancelled Requests Tab -->
    <div class="tab-pane fade" id="walkin-cancelled" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
<th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in walkin_cancelled_requests %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                   
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <!-- Completed Requests Tab -->
    <div class="tab-pane fade" id="walkin-completed" role="tabpanel">
      <section class="section">
        <div class="card">
          <div class="card-body">
            <table class="table datatable">
              <thead>
                <tr>
                  <th>Borrow ID</th>
                  <th>Date Requested</th>
                  <th>Date Needed</th>
                  <th>Due Date</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                {% for request in walkin_completed_requests %}
                <tr>
                  <td><a href="{% url 'borrowing_studentDetailedPreBookRequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                  <td>{{ request.request_date|date:"Y/m/d" }}</td>
                  <td>{{ request.borrow_date|date:"Y/m/d" }}</td>
                  <td>{{ request.due_date|date:"Y/m/d" }}</td>
                  <td>{% if request.due_date > request.borrow_date %}Long-Term{% else %}One-Day{% endif %}</td>
                   
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>
{% endif %}

<!-- No Requests Allowed -->
{% if not lab_config.allow_prebook and not lab_config.allow_walkin %}
    <div class="alert alert-warning">
        No borrowing requests are allowed for this laboratory.
    </div>
{% endif %}

<script>
function cancelRequest(rfNumber, requestType) {
    if (confirm('Are you sure you want to cancel this request?')) {
        // Send AJAX request to cancel
        fetch("{% url 'cancel_borrow_request' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',  // Django CSRF token
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                borrow_id: rfNumber,
                request_type: requestType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();  // Reload the page to update the request statuses
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }
}
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const hash = window.location.hash;
    
    if (hash) {
      const tab = document.querySelector(`a[href="${hash}"]`);
      if (tab) {
        tab.click();  // Activate tab
      }
    }
});

</script>

<style>
  .custom-cancel-btn {
    padding: 0.2rem 0.5rem; 
    font-size: 0.75rem; 
  }
</style>

{% endblock %}
