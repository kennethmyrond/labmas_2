{% extends 'temp_navbar.html' %}
{% block title %}Pre-Book Requests{% endblock %}

{% block content %}
<div class="pagetitle">
  <h1>Borrowing Requests</h1>
</div>

<style>
  .items_list{
    text-align: left;
  }
</style>

<!-- Tabs for Today, Future, Past, Cancelled, and Accepted borrows -->
<ul class="nav nav-tabs" id="borrowRequestsTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="today-tab" data-bs-toggle="tab" href="#today-borrows" role="tab">Today Borrow</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="past-tab" data-bs-toggle="tab" href="#past-borrows" role="tab">Past Borrows</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="future-tab" data-bs-toggle="tab" href="#future-borrows" role="tab">Future Borrows</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="cancelled-tab" data-bs-toggle="tab" href="#borrowed" role="tab">Marked As Borrowed</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="cancelled-tab" data-bs-toggle="tab" href="#cancelled-borrows" role="tab">Cancelled By Lab</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="accepted-tab" data-bs-toggle="tab" href="#accepted-borrows" role="tab">All Requests</a>
  </li>
</ul>

<!-- Tab content -->
<div class="tab-content">

  <!-- Today Borrow Tab -->
  <div class="tab-pane fade show active" id="today-borrows" role="tabpanel">
    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Today's Borrows</h5>
              <table class="table table-striped datatable">
                <thead>
                  <tr>
                    <th>Borrow ID</th>
                    <th>Borrower</th>
                    <th>Items</th>
                    <th>Confirm</th>
                    <th>Canel</th>
                  </tr>
                </thead>
                <tbody>
                  {% for request in today_borrows %}
                  <tr>
                    <td><a href="{% url 'borrowing_labtech_detailedprebookrequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                    <td>{{ request.user.firstname }} {{ request.user.lastname }}</td>
                    <td>
                      <ul>
                        {% for item in request.borrowed_items_set.all %}
                        <li>{{ item.item.item_name }} (×{{ item.qty }})</li>
                        {% endfor %}
                      </ul>
                    </td>
                    <td>
                      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmBorrowModal" data-id="{{ request.borrow_id }}">Mark as Borrowed</button>
                    </td>
                    <td>
                      <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmCancelModal" data-id="{{ request.borrow_id }}">Cancel</button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Future Borrows Tab -->
  <div class="tab-pane fade" id="future-borrows" role="tabpanel">
    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Future Borrows</h5>
              <table class="table table-striped datatable">
                <thead>
                  <tr>
                    <th>Borrow ID</th>
                    <th>Borrower</th>
                    <th>Items</th>
                    <th hidden></th>
                    <th hidden></th>
                  </tr>
                </thead>
                <tbody>
                  {% for request in future_borrows %}
                  <tr>
                    <td><a href="{% url 'borrowing_labtech_detailedprebookrequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                    <td>{{ request.user.firstname }} {{ request.user.lastname }}</td>
                    <td>
                      <ul>
                        {% for item in request.borrowed_items_set.all %}
                        <li>{{ item.item.item_name }} (×{{ item.qty }})</li>
                        {% endfor %}
                      </ul>
                    </td>
                    <td hidden></td>
                    <td hidden></td>
                    <!-- <td>
                      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmBorrowModal" data-id="{{ request.borrow_id }}">Mark as Borrowed</button>
                    </td>
                    <td>
                      <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmCancelModal" data-id="{{ request.borrow_id }}">Cancel</button>
                    </td> -->
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Past Borrows Tab -->
  <div class="tab-pane fade" id="past-borrows" role="tabpanel">
    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Past Borrows</h5>
              <table class="table table-striped datatable">
                <thead>
                  <tr>
                    <th>Borrow ID</th>
                    <th>Borrower</th>
                    <th>Items</th>
                    <th></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for request in past_borrows %}
                  <tr>
                    <td><a href="{% url 'borrowing_labtech_detailedprebookrequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                    <td>{{ request.user.firstname }} {{ request.user.lastname }}</td>
                    <td>
                      <ul>
                        {% for item in request.borrowed_items_set.all %}
                        <li>{{ item.item.item_name }} (×{{ item.qty }})</li>
                        {% endfor %}
                      </ul>
                    </td>
                    <td>
                      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmBorrowModal" data-id="{{ request.borrow_id }}">Mark as Borrowed</button>
                    </td>
                    <td>
                      <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmCancelModal" data-id="{{ request.borrow_id }}">Cancel</button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Cancelled Borrows Tab -->
  <div class="tab-pane fade" id="cancelled-borrows" role="tabpanel">
    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Cancelled Borrows</h5>
              <table class="table table-striped datatable">
                <thead>
                  <tr>
                    <th>Borrow ID</th>
                    <th>Borrower</th>
                    <th>Items</th>
                  </tr>
                </thead>
                <tbody>
                  {% for request in cancelled_borrows %}
                  <tr>
                    <td><a href="{% url 'borrowing_labtech_detailedprebookrequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                    <td>{{ request.user.firstname }} {{ request.user.lastname }}</td>
                    <td>
                      <ul>
                        {% for item in request.borrowed_items_set.all %}
                        <li>{{ item.item.item_name }} (×{{ item.qty }})</li>
                        {% endfor %}
                      </ul>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

    <!-- Cancelled Borrows Tab -->
    <div class="tab-pane fade" id="borrowed" role="tabpanel">
      <section class="section">
        <div class="row">
          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Marked As Borrowed</h5>
                <table class="table table-striped datatable">
                  <thead>
                    <tr>
                      <th>Borrow ID</th>
                      <th>Borrower</th>
                      <th>Items</th>
                      <th hidden></th>
                      <th hidden></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for request in borrowed_borrows %}
                    <tr>
                      <td><a href="{% url 'borrowing_labtech_detailedprebookrequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                      <td>{{ request.user.firstname }} {{ request.user.lastname }}</td>
                      <td>
                        <ul class="items_list" >
                          {% for item in request.borrowed_items_set.all %}
                          <li >{{ item.item.item_name }} (×{{ item.qty }})</li>
                          {% endfor %}
                        </ul>
                      </td>
                      <td hidden></td>
                      <td hidden></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

  <!-- Accepted Borrows Tab -->
  <div class="tab-pane fade" id="accepted-borrows" role="tabpanel">
    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">All requests</h5>
              <table class="table table-striped datatable">
                <thead>
                  <tr>
                    <th>Borrow ID</th>
                    <th>Borrower</th>
                    <th>Request Date</th>
                    <th>Items Borrowed</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for request in accepted_borrows %}
                  <tr>
                    <td><a href="{% url 'borrowing_labtech_detailedprebookrequests' request.borrow_id %}">{{ request.borrow_id }}</a></td>
                    <td>{{ request.user.firstname }} {{ request.user.lastname }}</td>
                    <td>{{ request.request_date|date:"Y/m/d" }}</td>
                    <td>
                      <ul>
                        {% for item in request.borrowed_items_set.all %}
                        <li>{{ item.item.item_name }} (×{{ item.qty }})</li>
                        {% endfor %}
                      </ul>
                    </td>
                    <td>{{ request.get_status_display }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Confirm Borrow Modal -->
<div class="modal fade" id="confirmBorrowModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Mark as Borrowed</h5>
        <button type="button" class="close" data-bs-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to mark this request as borrowed?
      </div>
      <div class="modal-footer">
        <form method="POST" id="borrowActionForm">
          {% csrf_token %}
          <input type="hidden" name="borrow_id" id="borrowActionId" value="">
          <button type="submit" name="action" value="borrowed" class="btn btn-success">Confirm</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Cancel Modal -->
<div class="modal fade" id="confirmCancelModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Cancellation</h5>
        <button type="button" class="close" data-bs-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <textarea name="remarks" form="cancelActionForm" class="form-control" placeholder="Enter remarks for cancellation"></textarea>
      </div>
      <div class="modal-footer">
        <form method="POST" id="cancelActionForm">
          {% csrf_token %}
          <input type="hidden" name="borrow_id" id="cancelActionId" value="">
          <button type="submit" name="action" value="cancel" class="btn btn-danger">Confirm Cancellation</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var confirmBorrowModal = document.getElementById('confirmBorrowModal');
    confirmBorrowModal.addEventListener('show.bs.modal', function(event) {
      var button = event.relatedTarget;
      var borrowId = button.getAttribute('data-id');
      var borrowActionInput = document.getElementById('borrowActionId');
      borrowActionInput.value = borrowId;
    });

    var confirmCancelModal = document.getElementById('confirmCancelModal');
    confirmCancelModal.addEventListener('show.bs.modal', function(event) {
      var button = event.relatedTarget;
      var borrowId = button.getAttribute('data-id');
      var cancelActionInput = document.getElementById('cancelActionId');
      cancelActionInput.value = borrowId;
    });
  });
</script>

{% endblock %}
