{% extends 'temp_navbar.html' %}
{% block title %}Detailed Pre-Book Request{% endblock %}
{% load custom_filters %}

{% block content %}
<div class="pagetitle">
    <h1>Borrowing Details</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'borrowing_labtech_prebookrequests' %}">Prepare Items Borrowed</a></li>
            <li class="breadcrumb-item active">Borrowing Details</li>
        </ol>
    </nav>
</div>

{% if messages %}
<div class="alert alert-success mt-3">
    {% for message in messages %}
    {{ message }}
    {% endfor %}
</div>
{% endif %}


<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div id="borrowerDetails">
                    <h5 class="card-title">Borrow ID: {{ borrow_entry.borrow_id }}</h5>
                    <p><strong>Borrow Name:</strong> {{ borrow_entry.user.firstname }} {{ borrow_entry.user.lastname }}</p>
                    <p><strong>Date Requested:</strong> {{ borrow_entry.request_date|date:"Y/m/d" }}</p>
                    <p><strong>Date Needed:</strong> {{ borrow_entry.borrow_date|date:"Y/m/d" }}</p>
                    <p><strong>Due Date:</strong> {{ borrow_entry.due_date|date:"Y/m/d" }}</p>
                    <p><strong>Status:</strong> {{ borrow_entry.get_status_display }}</p>
                    <p><strong>Remarks:</strong> {{ borrow_entry.remarks }}</p>
                    </div>
                    <hr>
                    <h5 class="card-title">Borrowed Items</h5>

                    
                    <div class="mt-4">
                        <button class="btn btn-primary" id="editBtn" onclick="enableEdit()" {% if borrow_entry.status != 'A' %}disabled{% endif %}>Edit Quantity</button>
                        <button class="btn btn-secondary d-none" id="revertBtn" onclick="revertEdit()" {% if borrow_entry.status != 'A' %}disabled{% endif %}>Revert Edit</button>
                    </div>
                    

                    <form method="POST" id="borrowRequestForm">
                        {% csrf_token %}
                        <input type="hidden" id="edited" name="edited" value="0">
                        <table class="table datatable" id="borrowedItemsTable">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Select Inventory Items (Match Borrowed Quantity)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in borrowed_items %}
                                <tr>
                                    <td>{{ item.item.item_name }}</td>
                                    <td>
                                        {% if borrow_entry.get_status_display == 'Completed' %}
                                        {{ item.qty }}
                                    {% else %}
                                        <input type="number" class="form-control qty-input" name="qty_{{ item.id }}" value="{{ item.qty }}" min="1" readonly>
                                    {% endif %}
                                    </td>
                                    <td>{{ item.unit }}</td>
                                    <!-- <td>
                                        <select class="form-select" name="inventory_item" multiple aria-label="multiple select example" id="inventory_item">
                                            {% for item in inventory_items %}
                                                <option value="{{ item.id }}">{{ item.id }}</option>
                                            {% endfor %}
                                        </select>
                                    </td> -->
                                    <td>
                                        <select class="form-select" aria-label="multiple select example" name="inventory_items_{{ item.id }}" multiple>
                                            {% for inv_item in inventory_items_map|get_item:item.id %}
                                                {% if inv_item.inventory_item_id|stringformat:"s" in item.inventory_item|default:"" %}
                                                    <option value="{{ inv_item.inventory_item_id }}">
                                                        {{ inv_item.inventory_item_id }}
                                                    </option>
                                                {% endif %}>
                                            {% endfor %}
                                        </select>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="mt-4">
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmBorrowModal" {% if borrow_entry.status == 'B' or today < borrow_entry.borrow_date %}disabled{% endif %} >Mark as Borrowed</button>
                            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmCancelModal" {% if borrow_entry.status == 'L' or today < borrow_entry.borrow_date %}disabled{% endif %} >Cancel</button>
                        </div>
                        <br>
                        {% if borrow_entry.get_status_display == 'Completed' %}
                        <button class="btn btn-info" id="downloadBtn">Download PDF</button>
                        {% endif %}

                    <!-- Confirm Borrow Modal -->
                    <div class="modal fade" id="confirmBorrowModal" tabindex="-1" aria-labelledby="confirmBorrowModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmBorrowModalLabel">Confirm Borrow</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <!-- <form method="POST"> -->
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <p>Are you sure you want to mark this request as "Borrowed"?</p>
                                        <div id="editReasonContainer" class="d-none">
                                            <label for="edit_reason">Reason for Quantity Update:</label>
                                            <textarea name="edit_reason" id="edit_reason" class="form-control" placeholder="Enter reason for quantity edits"></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <input type="hidden" name ="action" value="borrowed">
                                        <button type="button" class="btn btn-success" onclick="submitAcceptForm()">Confirm</button>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    </div>
                                <!-- </form> -->
                            </div>
                        </div>
                    </div>
                </form>

                    <!-- Confirm Cancel Modal -->
                    <div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmCancelModalLabel">Confirm Cancel</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="POST">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <label for="cancel_reason">Reason for Cancelling:</label>
                                        <textarea name="cancel_reason" id="cancel_reason" class="form-control" required></textarea>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="submit" name="action" value="cancel" class="btn btn-danger">Confirm Cancel</button>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>
            </div>         
          </div>
        </div>
    </div>
</section>

<script type="text/javascript">

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('downloadBtn').addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
    
           
            const borrowerDetails = document.getElementById('borrowerDetails').innerHTML;
            const table = document.getElementById('borrowedItemsTable');
    
           
            doc.setFontSize(12);
            doc.text(borrowerDetails.replace(/<[^>]*>/g, ''), 10, 10); // Removing HTML tags and adding it as plain text
    
            // Add the table below the borrower details
            doc.autoTable({ html: table, startY: 70 }); // Adjust Y position to avoid overlap with borrower details
    
            
            const borrowId = '{{ borrow_entry.borrow_id }}';
            const firstName = '{{ borrow_entry.user.firstname }}';
            const lastName = '{{ borrow_entry.user.lastname }}';
            const borrowDate = '{{ borrow_entry.borrow_date|date:"Y/m/d" }}';
            const dueDate = '{{ borrow_entry.due_date|date:"Y/m/d" }}';
            const fileName = `borrowrequest_${borrowId}_${firstName}${lastName}${borrowDate}_to_${dueDate}_${status}.pdf`;
    
            
            doc.save(fileName);
        });
    });

    const originalQuantities = {{ borrowed_items_json|safe }};
    
    function enableEdit() {
        document.querySelectorAll('.qty-input').forEach(input => {
            input.readOnly = false;
        });
        document.getElementById('editBtn').classList.add('d-none');
        document.getElementById('revertBtn').classList.remove('d-none');
        document.getElementById('edited').value = '1';
    }

    function revertEdit() {
        document.querySelectorAll('.qty-input').forEach((input, index) => {
            input.value = originalQuantities[index].qty;
            input.readOnly = true;
        });
        document.getElementById('editBtn').classList.remove('d-none');
        document.getElementById('revertBtn').classList.add('d-none');
        document.getElementById('edited').value = '0';
    }

    function submitAcceptForm() {
      const form = document.getElementById('borrowRequestForm');
      form.submit(); 
    }

    document.getElementById('confirmBorrowModal').addEventListener('show.bs.modal', function () {
        const editReasonContainer = document.getElementById('editReasonContainer');
        if (document.getElementById('edited').value === '1') {
            editReasonContainer.classList.remove('d-none');
        } else {
            editReasonContainer.classList.add('d-none');
        }
    });
</script>
{% endblock %}
